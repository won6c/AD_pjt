{% extends "base.html" %}
{% load static %}
{% block content %}
<h2 class="text-center mt-4">ğŸ® Classic DOOM (JS-DOS ì‹¤í–‰)</h2>

<div class="d-flex justify-content-center align-items-center" style="min-height: 90vh;">
  <div id="dosbox" class="dosbox-container shadow rounded" style="width: 960px; height: 720px; background-color: #000;"></div>
</div>

<script src="https://js-dos.com/cdn/js-dos-api.js"></script>
<script>
  // CSRF í† í° ì¶”ì¶œ í•¨ìˆ˜
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Doom ì‹¤í–‰ & ì‹œê°„ ì¸¡ì •
  const dosbox = new Dosbox({
    id: "dosbox",
    autolock: true,
    scale: 2,
    onload: function (dosbox) {
      dosbox.run("{% static 'doom-js/doom.zip' %}", "./DOOM.EXE");

      // ğŸ•’ ì‹œì‘ ì‹œê°„ ê¸°ë¡
      const startTime = Date.now();

      // â±ï¸ 2ë¶„ í›„ ì„œë²„ì— í”Œë ˆì´ ê¸°ë¡ ì „ì†¡ (ì„ì‹œ í…ŒìŠ¤íŠ¸ìš©)
      setTimeout(() => {
        const endTime = Date.now();
        const duration = Math.round((endTime - startTime) / 1000); // ì´ˆ ë‹¨ìœ„

        fetch("/api/game/doom/record/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({
            duration: duration,
            score: 0  // ì ìˆ˜ ì‹œìŠ¤í…œ ì¶”ê°€ë˜ë©´ ìˆ˜ì • ê°€ëŠ¥
          })
        }).then(response => {
          if (response.ok) {
            console.log("âœ… í”Œë ˆì´ ê¸°ë¡ ì €ì¥ ì™„ë£Œ");
          } else {
            console.warn("âŒ ì €ì¥ ì‹¤íŒ¨");
          }
        }).catch(err => {
          console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜", err);
        });
      }, 2 * 60 * 1000);  // 2ë¶„ í›„ ìë™ ì €ì¥
    }
  });
</script>
{% endblock %}
